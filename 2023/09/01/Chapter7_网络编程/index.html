<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
  
  <title>第七章：网络编程 | 江城子同学</title>
  
  <meta name="author" content="flyingfox" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="system programming" />
  
  <meta name="description" content="介绍网络编程中的套接字相关内容：报式套接字、流式套接字（待更新）">
<meta property="og:type" content="article">
<meta property="og:title" content="第七章：网络编程">
<meta property="og:url" content="http://example.com/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="江城子同学">
<meta property="og:description" content="介绍网络编程中的套接字相关内容：报式套接字、流式套接字（待更新）">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/images/thumbnail/network-programming.png">
<meta property="article:published_time" content="2023-09-01T13:00:00.000Z">
<meta property="article:modified_time" content="2023-09-01T08:59:59.317Z">
<meta property="article:author" content="flyingfox">
<meta property="article:tag" content="system programming">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/images/thumbnail/network-programming.png">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                        
                                            <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
                                        
                                    
                                        
                                            <li><a href="/archives/"><i class="fa fa-file"></i>档案馆</a></li>
                                        
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">江城子同学</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>江城子同学</h2> <br />
                        <span>十年饮冰，难凉热血</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">第七章：网络编程</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-09-01T13:00:00.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-09-01</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">flyingfox</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~33.52K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1693558799317"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
                <div class="kratos-post-inner-toc toc-div-class" >
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E7%9A%84%E4%BC%A0%E8%BE%93%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">跨主机的传输要注意的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="toc-number">1.1.</span> <span class="toc-text">字节序问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">字节序转换函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">格式转换函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#inet-pton-3"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">inet_pton(3)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#inet-ntop-3"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">inet_ntop(3)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E9%BD%90"><span class="toc-number">1.2.</span> <span class="toc-text">对齐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E9%95%BF%E5%BA%A6%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.</span> <span class="toc-text">类型长度问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">2.</span> <span class="toc-text">套接字</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#socket-2"><span class="toc-number">2.1.</span> <span class="toc-text">socket(2)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E5%BC%8F%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">2.2.</span> <span class="toc-text">报式套接字</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.1.</span> <span class="toc-text">常用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#bind-2"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">bind(2)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sendto-2"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">sendto(2)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#recvfrom-2"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">recvfrom(2)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD"><span class="toc-number">2.2.2.</span> <span class="toc-text">多播</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#setsockopt"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">setsockopt()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-number">2.3.</span> <span class="toc-text">流式套接字</span></a></li></ol></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><p>介绍网络编程中的套接字相关内容：报式套接字、流式套接字（待更新）</p>
<span id="more"></span>

<p>注：从系统开发角度来讲，作为程序员的必备素质：<a>精通两门编程语言，精通一门脚本（Python），扎实的网络知识。</a></p>
<p>socket 本身有“插座”的意思，在 Linux 环境下，用于表示进程间网络通信的特殊文件类型。本质为内核借助缓冲区形成的伪文件。既然是文件，那么理所当然的，可以使用文件描述符引用套接字。与管道类似的，Linux 系统将其封装成文件的目的是为了统一接口，使得读写套接字和读写文件的操作一致。区别在于<strong>管道主要应用于本地进程间通信，而套接字多应用于网络进程间数据的传递</strong>。</p>
<p>套接字通信分两部分：</p>
<ul>
<li>服务器端：被动接受连接，一般不会主动发起连接；</li>
<li>客户端：主动向服务器发起连接；</li>
</ul>
<h2 id="跨主机的传输要注意的问题"><a href="#跨主机的传输要注意的问题" class="headerlink" title="跨主机的传输要注意的问题"></a>跨主机的传输要注意的问题</h2><h3 id="字节序问题"><a href="#字节序问题" class="headerlink" title="字节序问题"></a>字节序问题</h3><p>字节序，顾名思义字节的顺序，就是大于一个字节类型的数据在内存中的存放顺序(一个字节的数据当然就无需谈顺序的问题了)。</p>
<ul>
<li>大端字节序(Big-Endian)：低地址处放高字节；</li>
<li>小端字节序(Little-Endian)：低地址处放低字节；</li>
</ul>
<h4 id="字节序转换函数"><a href="#字节序转换函数" class="headerlink" title="字节序转换函数"></a>字节序转换函数</h4><p>当格式化的数据在两台使用不同字节序的主机之间直接传递时，接收端必然错误的解释之。解决问题的方法是：<a>发送端总是把要发送的数据转换成大端字节序数据后再发送，而接收端知道对方传送过来的数据总是采用大端字节序，所以接收端可以根据自身采用的字节序决定是否对接收到的数据进行转换（小端机转换，大端机不转换）。</a></p>
<p>网络字节顺序是 TCP&#x2F;IP 中规定好的一种数据表示格式，它与具体的 CPU 类型、操作系统等无关，从而可以保证数据在不同主机之间传输时能够被正确解释，<strong>网络字节顺序采用大端排序方式</strong>。BSD Socket提供了封装好的转换接口，方便程序员使用。包括从主机字节序到网络字节序的转换函数：htons、htonl；从网络字节序到主机字节序的转换函数：ntohs、ntohl。（两字节的长度用”s”表示，四字节的长度用”l”表示）</p>
<ul>
<li>h - host 主机，主机字节序；</li>
<li>n - network 网络字节序；</li>
<li>s - short unsigned short；</li>
<li>l - long unsigned int；</li>
</ul>
<p>网络通信时，需要将主机字节序转换成网络字节序（大端），另外一段获取到数据以后根据情况将网络字节序转换成主机字节序。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="comment">// 转换端口</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">htons</span><span class="params">(<span class="type">uint16_t</span> hostshort)</span>;		<span class="comment">// 主机字节序 -&gt; 网络字节序</span></span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">ntohs</span><span class="params">(<span class="type">uint16_t</span> netshort)</span>;		<span class="comment">// 主机字节序 -&gt; 网络字节序</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转IP</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">htonl</span><span class="params">(<span class="type">uint32_t</span> hostlong)</span>;		<span class="comment">// 主机字节序 -&gt; 网络字节序</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">ntohl</span><span class="params">(<span class="type">uint32_t</span> netlong)</span>;		<span class="comment">// 主机字节序 -&gt; 网络字节序</span></span><br></pre></td></tr></table></figure>

<p>举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// htons 转换端口</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> a = <span class="number">0x1234</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;a = 0x%x\n&quot;</span>, a);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> b = htons(a);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;b = 0x%x\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// htonl  转换IP</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> buf[<span class="number">4</span>] = &#123;<span class="number">192</span>, <span class="number">168</span>, <span class="number">34</span>, <span class="number">129</span>&#125;;</span><br><span class="line">	<span class="type">uint32_t</span> num = *(<span class="type">uint32_t</span> *)buf;</span><br><span class="line">	<span class="type">uint32_t</span> sum = htonl(num);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p = (<span class="type">char</span> *)&amp;sum;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d.%d.%d.%d\n&quot;</span>, *p, *(p + <span class="number">1</span>), *(p + <span class="number">2</span>), *(p + <span class="number">3</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">// ntohl</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> buf1[<span class="number">4</span>] = &#123;<span class="number">128</span>, <span class="number">34</span>, <span class="number">168</span>, <span class="number">192</span>&#125;;</span><br><span class="line">	<span class="type">uint32_t</span> num1 = *(<span class="type">uint32_t</span> *)buf1;</span><br><span class="line">	<span class="type">uint32_t</span> sum1 = ntohl(num1);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p1 = (<span class="type">unsigned</span> <span class="type">char</span> *)&amp;sum1;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d.%d.%d.%d\n&quot;</span>, *p1, *(p1 + <span class="number">1</span>), *(p1 + <span class="number">2</span>), *(p1 + <span class="number">3</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> buf2[<span class="number">4</span>] = &#123;<span class="number">128</span>, <span class="number">34</span>, <span class="number">168</span>, <span class="number">192</span>&#125;;</span><br><span class="line">	<span class="type">uint32_t</span> ip = *(<span class="type">uint32_t</span> *)buf2;</span><br><span class="line">	<span class="type">uint32_t</span> network_order = htonl(ip);</span><br><span class="line">	<span class="comment">// 将网络字节序的IP地址转换为点分十进制格式</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">addr</span>;</span></span><br><span class="line">	addr.s_addr = network_order;</span><br><span class="line">	<span class="type">char</span> *ip_str = inet_ntoa(addr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;IP address: %s\n&quot;</span>, ip_str);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = 0x1234</span><br><span class="line">b = 0x3412</span><br><span class="line">129.34.168.192</span><br><span class="line">IP address: 192.168.34.128</span><br></pre></td></tr></table></figure>

<h4 id="格式转换函数"><a href="#格式转换函数" class="headerlink" title="格式转换函数"></a>格式转换函数</h4><p>通常，人们习惯用可读性好的字符串来表示 IP 地址，比如用点分十进制字符串表示 IPv4 地址，以及用十六进制字符串表示 IPv6 地址。但编程中需要先把它们转化为整数（二进制数）方能使用。而记录日志时则相反，要把整数表示的 IP 地址转化为可读的字符串。inet_pton()，inet_ntop() 函数可用于 <strong>点分十进制字符串</strong> 表示的 IPv4 地址和 <strong>二进制格式的网络字节序整数</strong> 表示的 IPv4 地址之间的转换，并且它们适用 IPv4 地址和 IPv6 地址：</p>
<h5 id="inet-pton-3"><a href="#inet-pton-3" class="headerlink" title="inet_pton(3)"></a>inet_pton(3)</h5><p>inet_pton() 函数（”presentation to network”）用于将字符串格式的IP地址转换为二进制格式的网络字节序整数。函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">inet_pton</span><span class="params">(<span class="type">int</span> af, <span class="type">const</span> <span class="type">char</span> *src, <span class="type">void</span> *dst)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>af</code>：地址族。常见的值有：<ul>
<li><code>AF_INET</code>：IPv4协议；</li>
<li><code>AF_INET6</code>：IPv6协议；</li>
</ul>
</li>
<li><code>src</code>：指向以null结尾的字符串格式的源IP地址。</li>
<li><code>dst</code>：指向目标结构的指针，用于存储转换后的二进制格式的IP地址。对于IPv4，它是一个<code>struct in_addr</code>类型的指针；对于IPv6，它是一个<code>struct in6_addr</code>类型的指针。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回 1；</li>
<li>输入不是有效的IP地址格式时，返回 0；</li>
<li>发生错误时，返回 -1，并设置 <code>errno</code>。</li>
</ul>
<p>举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip_str = <span class="string">&quot;192.168.1.1&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">ip_addr</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inet_pton(AF_INET, ip_str, &amp;ip_addr) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;inet_pton error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Binary format of IP: %u\n&quot;</span>, ntohl(ip_addr.s_addr));</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Binary format of IP: 3232235777</span><br></pre></td></tr></table></figure>

<h5 id="inet-ntop-3"><a href="#inet-ntop-3" class="headerlink" title="inet_ntop(3)"></a>inet_ntop(3)</h5><blockquote>
<p>  <em>INET_NTOP(3)</em></p>
<p>  <em><strong>NAME</strong></em></p>
<p>  ​       <em>inet_ntop - convert IPv4 and IPv6 addresses from binary to text form</em></p>
<p>  <em><strong>SYNOPSIS</strong></em></p>
<p>  ​       <em>#include &lt;arpa&#x2F;inet.h&gt;</em></p>
<p>  ​       <em>const char *inet_ntop(int af, const void *src, char *dst, socklen_t size);</em></p>
<p>  <em><strong>DESCRIPTION</strong></em></p>
<p>  ​       <em>This function converts the network address structure src in the af address family into a character string.  The resulting string is copied to the buffer pointed to by dst, which must be a non-null pointer.  The caller specifies the number of bytes available in this buffer in the argument size.</em></p>
<p>  ​       <em>inet_ntop() extends the inet_ntoa(3) function to support multiple address families, inet_ntoa(3) is now considered to be deprecated in favor of  inet_ntop().   The following address families are currently supported:</em></p>
<p>  ​       <em><strong>AF_INET</strong></em> <em>src  points  to a struct in_addr (in network byte order) which is converted to an IPv4 network address in the dotted-decimal format, “ddd.ddd.ddd.ddd”.  The buffer dst must be at least INET_ADDRSTRLEN bytes long.</em></p>
<p>  ​       <em><strong>AF_INET6</strong></em> <em>src points to a struct in6_addr (in network byte order) which is converted to a representation of this address in the most appropriate IPv6 network  address format for this address.  The buffer dst must be at least INET6_ADDRSTRLEN bytes long.</em></p>
<p>  <em><strong>RETURN VALUE</strong></em></p>
<p>  ​       <em>On success, inet_ntop() returns a non-null pointer to dst.  NULL is returned if there was an error, with errno set to indicate the error.</em></p>
</blockquote>
<p>inet_ntop() 函数（”network to presentation”）用于将二进制格式的IP地址转换为字符串格式。函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">inet_ntop</span><span class="params">(<span class="type">int</span> af, <span class="type">const</span> <span class="type">void</span> *src, <span class="type">char</span> *dst, <span class="type">socklen_t</span> size)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>af</code>：地址族。常见的值有：<ul>
<li><code>AF_INET</code>：IPv4协议；</li>
<li><code>AF_INET6</code>：IPv6协议；</li>
</ul>
</li>
<li><code>src</code>：指向二进制格式源IP地址的指针。</li>
<li><code>dst</code>：指向存储转换后字符串格式IP地址的缓冲区的指针。</li>
<li><code>size</code>：<code>dst</code>缓冲区的大小。对于IPv4地址，它应至少为<code>INET_ADDRSTRLEN</code>，对于IPv6地址，至少为<code>INET6_ADDRSTRLEN</code>。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回一个指向目标缓冲区的指针，该缓冲区包含转换后的字符串；</li>
<li>失败时，返回 <code>NULL</code> 并设置 <code>errno</code>。</li>
</ul>
<p>举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">ip_addr</span>;</span></span><br><span class="line">    ip_addr.s_addr = htonl(<span class="number">3232235777</span>);  <span class="comment">// 192.168.1.1 in binary</span></span><br><span class="line">    <span class="type">char</span> str_addr[INET_ADDRSTRLEN];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inet_ntop(AF_INET, &amp;ip_addr, str_addr, <span class="keyword">sizeof</span>(str_addr)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;inet_ntop error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;String format of IP: %s\n&quot;</span>, str_addr);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String format of IP: 192.168.1.1</span><br></pre></td></tr></table></figure>

<h3 id="对齐"><a href="#对齐" class="headerlink" title="对齐"></a>对齐</h3><p>对齐方式不一样的解决方法是不对齐。</p>
<h3 id="类型长度问题"><a href="#类型长度问题" class="headerlink" title="类型长度问题"></a>类型长度问题</h3><p>比如int类型占多大，char型有没有符号，标准C中对这些问题都没有严格的指定。</p>
<p>解决方法：比如int32_t（32位有符号整型数），uint32_t（32位无符号整型数），int8_t，uint8_t。</p>
<h2 id="套接字"><a href="#套接字" class="headerlink" title="套接字"></a>套接字</h2><p>背景：在计算机网络发展的早期，不同的网络协议和技术都有各自独特的接口和调用方式。例如，某些接口可能只支持 TCP&#x2F;IP 协议，而另一些接口可能只支持其他类型的网络协议。这使得网络编程变得相当复杂和混乱。</p>
<p>为了解决这个问题，计算机科学家在 UNIX 操作系统中引入了套接字（Socket）的概念。套接字提供了一个统一的网络编程接口，使得程序员可以使用相同的函数和数据结构，不管底层使用的是什么网络协议。socket() 函数就是创建套接字的函数。</p>
<p><img src="https://flyingfox092-1300215590.cos.ap-shanghai.myqcloud.com/system-programming/sp7-socket-backgroup.png"></p>
<p>底层用哪种协议，上层用哪种实现方式都不好确定，于是抽象出来了socket机制，socket是个中间层，返回一个文件描述符。</p>
<h3 id="socket-2"><a href="#socket-2" class="headerlink" title="socket(2)"></a>socket(2)</h3><blockquote>
<p>  <em>SOCKET(2)</em> </p>
<p>  <em><strong>NAME</strong></em></p>
<p>  ​       <em>socket - create an endpoint for communication</em></p>
<p>  <em><strong>SYNOPSIS</strong></em></p>
<p>  ​       <em>#include &lt;sys&#x2F;types.h&gt;</em></p>
<p>  ​       <em>#include &lt;sys&#x2F;socket.h&gt;</em></p>
<p>  ​       <em>int socket(int domain, int type, int protocol);</em></p>
<p>  <em><strong>DESCRIPTION</strong></em></p>
<p>  ​       <em>socket() creates an endpoint for communication and returns a file descriptor that refers to that endpoint.  The file descriptor returned by a successful call will be the lowest-numbered file descriptor not currently open for the process.</em></p>
<p>  ​       <em>The domain argument specifies a communication domain; this selects the protocol family which will be used for communication.  These families are defined in &lt;sys&#x2F;socket.h&gt;.  The formats currently understood by the Linux kernel include:</em></p>
<p>  <em>Name         Purpose                                    Man page</em></p>
<p>  <em><strong>AF_UNIX</strong></em>      <em>Local communication               unix(7)</em></p>
<p>  <em><strong>AF_INET</strong></em>      <em>IPv4 Internet protocols              ip(7)</em>   </p>
<p>  <em><strong>AF_INET6</strong></em>     <em>IPv6 Internet protocols             ipv6(7)</em></p>
<p>  ​       <em>Further details of the above address families, as well as information on several other address families, can be found in address_families(7).</em></p>
<p>  ​       <em>The socket has the indicated type, which specifies the communication semantics.  Currently defined types are:</em></p>
<p>  <a><em><strong>SOCK_STREAM</strong> Provides sequenced, reliable, two-way, connection-based byte streams.  An out-of-band data transmission mechanism may be supported.</em></a></p>
<p>  <a><em><strong>SOCK_DGRAM</strong> Supports datagrams (connectionless, unreliable messages of a fixed maximum length).</em></a></p>
<p>  ​       <em>The protocol specifies a particular protocol to be used with the socket.  Normally only a single protocol exists to support a particular socket type within a given protocol family, in which case protocol can be specified as 0.  However,  it is  possible  that  many  protocols  may  exist, in which case a particular protocol must be specified in this manner.  The protocol number to use is specific to the “communication domain” in which communication is to take place; see protocols(5).  See getprotoent(3) on how to map protocol name strings to protocol numbers.</em></p>
<p>  <em><strong>RETURN VALUE</strong></em></p>
<p>  ​       <em>On success, a file descriptor for the new socket is returned.  On error, -1 is returned, and errno is set appropriately.</em></p>
<p>  <em><strong>ERRORS</strong></em></p>
<p>  ​       <em><strong>EACCES</strong> Permission to create a socket of the specified type and&#x2F;or protocol is denied.</em></p>
<p>  ​       <em><strong>EAFNOSUPPORT</strong> The implementation does not support the specified address family.</em></p>
<p>  ​       <em><strong>EINVAL</strong> Unknown protocol, or protocol family not available.</em></p>
<p>  ​       <em><strong>EINVAL</strong> Invalid flags in type.</em></p>
<p>  ​       <em><strong>EMFILE</strong> The per-process limit on the number of open file descriptors has been reached.</em></p>
<p>  ​       <em><strong>ENFILE</strong> The system-wide limit on the total number of open files has been reached.</em></p>
<p>  ​       <em><strong>ENOBUFS</strong> or <strong>ENOMEM</strong> Insufficient  memory  is  available.   The socket cannot be created until sufficient resources are freed.</em></p>
<p>  ​       <em><strong>EPROTONOSUPPORT</strong> The protocol type or the specified protocol is not supported within this domain.</em></p>
<p>  ​       <em>Other errors may be generated by the underlying protocol modules.</em></p>
</blockquote>
<p>socket() 函数用于创建一个新的套接字，并返回一个与之相关的文件描述符。它允许应用程序指定所需的协议族、套接字类型和具体协议。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>domain</code>：指定创建的套接字所用的协议族。常见的值有：<ul>
<li><code>AF_INET</code>：IPv4协议；</li>
<li><code>AF_INET6</code>：IPv6协议；</li>
<li><code>AF_UNIX</code>：UNIX域协议；</li>
</ul>
</li>
<li><code>type</code>：指定套接字的类型。常见的值有：<ul>
<li><code>SOCK_STREAM</code>：字节流套接字，提供面向连接的、可靠的字节流服务。通常用于 TCP。</li>
<li><code>SOCK_DGRAM</code>：数据报套接字，提供无连接的、不可靠的数据报服务。通常用于 UDP。</li>
<li><code>SOCK_RAW</code>：原始套接字，提供访问底层网络协议的能力，常用于实现新的协议或访问 ICMP 。</li>
</ul>
</li>
<li><code>protocol</code>：指定特定的协议。通常设置为 <code>0</code>，以使用该类型的默认协议。例如，对于 <code>SOCK_STREAM</code>，默认的协议是 TCP。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回一个非负整数，这是新创建的套接字的文件描述符；</li>
<li>失败时，返回 -1， 并设置 <code>errno</code>。</li>
</ul>
<p>注意事项：</p>
<ol>
<li>sequenced，reliable：指的是只要接收方接到数据，就保证当前包中的数据是正确的（顺序和内容都正确），一定会丢包。</li>
<li>connection-based：从程序员的角度来说，不局限于三次握手，一说基于连接的，那就是点对点的，一对一的，每个人专用的。</li>
<li>套接字，就像文件描述符一样，是有限的系统资源，当不再需要它们时，应确保关闭它们以避免资源泄露。</li>
<li>错误处理：socket() 调用可能会因多种原因失败，例如：系统资源不足、指定了无效的参数等。因此，对其返回值进行检查并处理任何错误是很重要的。</li>
</ol>
<p>举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sockfd;</span><br><span class="line"></span><br><span class="line">	sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(sockfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;socket()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Socket created with file descriptor: %d\n&quot;</span>, sockfd);</span><br><span class="line"></span><br><span class="line">	close(sockfd);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Socket created with file descriptor: 3</span><br></pre></td></tr></table></figure>

<h3 id="报式套接字"><a href="#报式套接字" class="headerlink" title="报式套接字"></a>报式套接字</h3><p>看一个程序员会不会写网络传输的程序，多半看的是能不能完成报式的传输。报式套接字需要程序员指定和封装的内容稍微丰富一些。</p>
<p>被动端（先运行）：</p>
<ol>
<li>取得SOCKET；</li>
<li>给SOCKET取得地址；</li>
<li>收&#x2F;发信息；</li>
<li>关闭SOCKET；</li>
</ol>
<p>主动端：</p>
<ol>
<li>取得SOCKET；</li>
<li>给SOCKET取得地址（可省略）；</li>
<li>发&#x2F;收信息；</li>
<li>关闭SOCKET；</li>
</ol>
<img src="https://flyingfox092-1300215590.cos.ap-shanghai.myqcloud.com/system-programming/sp7-udp.png" style="zoom: 67%;" />

<h4 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h4><h5 id="bind-2"><a href="#bind-2" class="headerlink" title="bind(2)"></a>bind(2)</h5><p>函数背景：在网络编程中，为了让服务器能够接受来自客户端的连接，服务器必须在某个网络接口和端口上进行监听。bind() 函数允许我们将套接字与特定的网络接口和端口号关联起来，从而准备接受来自该接口和端口的连接。</p>
<blockquote>
<p>  <em>BIND(2)</em></p>
<p>  <em><strong>NAME</strong></em></p>
<p>  ​       <em>bind - bind a name to a socket</em></p>
<p>  <em><strong>SYNOPSIS</strong></em></p>
<p>  ​       <em>#include &lt;sys&#x2F;types.h&gt;</em></p>
<p>  ​       <em>#include &lt;sys&#x2F;socket.h&gt;</em></p>
<p>  ​       <em>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</em></p>
<p>  <em><strong>DESCRIPTION</strong></em></p>
<p>  ​       <em>When a socket is created with socket(2), it exists in a name space (address family) but has no address assigned to it.  bind() assigns the address specified by <u>addr</u> to the socket referred to by the file descriptor <u>sockfd</u>.  <u>addrlen</u> specifies the size, in bytes, of the address structure pointed to by <u>addr</u>.  Traditionally, this operation is called “<strong>assigning a name to a socket</strong>“.</em></p>
<p>  ​       <em>It is normally necessary to assign a local address using bind() before a SOCK_STREAM socket may receive connections (see accept(2)).</em></p>
<p>  ​       <em>The rules used in name binding vary between address families.  Consult the manual entries in Section 7 for detailed information.  For AF_INET, see ip(7); for AF_INET6, see ipv6(7); for AF_UNIX, see unix(7); for AF_APPLETALK, see ddp(7); for AF_PACKET, see packet(7); for AF_X25, see x25(7); and for AF_NETLINK, see netlink(7).</em></p>
<p>  ​       <em>The actual structure passed for the <u>addr</u> argument will depend on the address family.  The <u>sockaddr</u> structure is defined as something like:</em></p>
<p>  ​           <em>struct sockaddr {</em></p>
<p>  ​               <em>sa_family_t sa_family;</em></p>
<p>  ​               <em>char        sa_data[14];</em></p>
<p>  ​           <em>}</em></p>
<p>  ​       <em>The only purpose of this structure is to cast the structure pointer passed in <u>addr</u> in order to avoid compiler warnings.  See EXAMPLE below.</em></p>
<p>  <em><strong>RETURN VALUE</strong></em></p>
<p>  ​       <em>On success, zero is returned.  On error, -1 is returned, and errno is set appropriately.</em></p>
</blockquote>
<p>bind() 函数用于将套接字与特定的IP地址和端口号绑定，它允许服务器指定在哪些网络接口和端口上监听客户端的连接。函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>sockfd</code>：之前通过 socket() 创建的套接字的文件描述符。</li>
<li><code>addr</code>：指向<code>sockaddr</code>结构的指针，该结构包含要绑定到的IP地址和端口号。实际上，通常我们会使用<code>sockaddr_in</code>（对于IPv4）或<code>sockaddr_in6</code>（对于IPv6）结构，但在调用 bind() 时，我们需要将它们强制转换为<code>sockaddr</code>。</li>
<li><code>addrlen</code>：地址结构的大小。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回 0；</li>
<li>失败时，返回 -1，并设置 <code>errno</code>。</li>
</ul>
<p>注意事项：</p>
<ol>
<li><p>将套接字与一个地址（IP 地址和端口号）绑定。这对于服务器程序来说是必要的，因为它 <strong>需要在特定的地址上监听客户端的连接请求</strong>。该函数接受一个套接字描述符、一个指向地址结构的指针（如 sockaddr_in 或 sockaddr_in6）以及地址结构的大小。</p>
</li>
<li><p><strong>sockaddr</strong> 结构：</p>
<p>在网络编程中，地址结构是用于存储网络地址的。网络地址包括IP地址和端口号等信息，因此在C中，我们需要一种数据结构来存储这些信息。但问题在于，不同的协议族（例如IPv4和IPv6）对地址的表示形式不同，需要的存储空间也不同。例如，IPv4地址需要32位，而IPv6地址需要128位。因此，我们需要一种灵活的方式来表示地址。</p>
<p>sockaddr结构就是这样一种灵活的表示方式。它包含一个sa_family字段，用于表示地址族（例如AF_INET表示IPv4，AF_INET6表示IPv6），以及一个sa_data字段，用于存储实际的地址信息。由于sa_data是一个字符数组，它可以存储任何形式的地址。</p>
<p>然而，sockaddr结构在实际使用中并不方便。例如，如果我们要设置一个IPv4地址，我们需要手动将IP地址和端口号等信息编码到sa_data字段中，这是非常麻烦的。因此，通常我们会使用更具体的地址结构，例如sockaddr_in结构（用于IPv4）或sockaddr_in6结构（用于IPv6）。这些结构在sockaddr的基础上增加了一些字段，使得设置地址更方便。</p>
<p>然后我们在需要传递地址结构的函数（例如bind()和accept()）中，我们仍然需要使用sockaddr结构。这是因为这些函数需要处理任何形式的地址，它们不能假设地址一定是IPv4或IPv6形式。因此，我们通常会将sockaddr_in或sockaddr_in6结构强制转换为sockaddr结构，然后传递给这些函数。这就是上面段落中所说的 “<strong>将addr的结构指针转换为sockaddr结构，以避免编译器警告</strong>” 的含义。<u>实际上，sockaddr结构的唯一用途就是作为这种转换的目标</u>。</p>
</li>
<li><p>选择正确的地址和端口：在多网卡的系统中，确保选择正确的网络接口（或使用 <code>INADDR_ANY</code> 绑定到所有接口）。确保选择的端口号不在其他应用程序使用，通常建议使用大于 <code>1024</code> 的端口号，因为较低的端口号通常保留给标准服务。</p>
</li>
<li><p>地址复用：如果应用程序可能频繁地启动并立即关闭，或者在短时间内重启，考虑使用 setsockopt() 设置 <code>SO_REUSEADDR</code> 选项，这样可以避免 “address already in use” 错误。</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在写数据的时候不好用</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line">	<span class="type">sa_family_t</span> sa_family;       <span class="comment">// 地址族协议, ipv4</span></span><br><span class="line">	<span class="type">char</span>        sa_data[<span class="number">14</span>];     <span class="comment">// 端口(2字节) + IP地址(4字节) + 填充(8字节)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span>  <span class="type">uint16_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">int</span>    <span class="type">uint32_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint16_t</span> <span class="type">in_port_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> <span class="type">in_addr_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> <span class="type">sa_family_t</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SOCKADDR_COMMON_SIZE (sizeof (unsigned short int))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">in_addr_t</span> s_addr;</span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// sizeof(struct sockaddr) == sizeof(struct sockaddr_in)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span> sin_family;		<span class="comment">/* 地址族协议: AF_INET */</span></span><br><span class="line">    <span class="type">in_port_t</span> sin_port;         <span class="comment">/* 端口, 2字节-&gt; 大端  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span>    <span class="comment">/* IP地址, 4字节 -&gt; 大端  */</span></span><br><span class="line">    <span class="comment">/* 填充 8字节 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> sin_zero[<span class="keyword">sizeof</span> (<span class="keyword">struct</span> sockaddr) - <span class="keyword">sizeof</span>(sin_family) -</span><br><span class="line">               <span class="keyword">sizeof</span> (<span class="type">in_port_t</span>) - <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in_addr)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sockfd;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">	<span class="type">char</span> ip[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">	sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(sockfd == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;socket()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">	addr.sin_family = AF_INET;</span><br><span class="line">	addr.sin_port = htons(<span class="number">8080</span>);</span><br><span class="line">	<span class="comment">// addr.sin_addr.s_addr = INADDR_ANY;	// Bind to any local IP</span></span><br><span class="line">	inet_pton(AF_INET, <span class="string">&quot;127.0.0.1&quot;</span>, &amp;addr.sin_addr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(bind(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(addr)) == <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// perror(&quot;bind()&quot;);</span></span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;bind() failded: %s\n&quot;</span>, strerror(errno));</span><br><span class="line">		close(sockfd);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *str = inet_ntop(AF_INET, &amp;addr.sin_addr.s_addr, ip, <span class="number">16</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Server bound to %s:%d\n&quot;</span>, str, ntohs(addr.sin_port));</span><br><span class="line">	close(sockfd);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Server bound to 127.0.0.1:8080</span><br></pre></td></tr></table></figure>

<h5 id="sendto-2"><a href="#sendto-2" class="headerlink" title="sendto(2)"></a>sendto(2)</h5><p>函数背景：在使用 UDP 进行网络通信时，数据是通过单独的数据报文发送的，而不是像 TCP 那样的流式传输。sendto() 函数是专门为无连接的数据报套接字（如 UDP）设计的，它允许开发者将数据发送到指定的远程地址和端口。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendto</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *dest_addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>sockfd</code>：要发送数据的套接字的文件描述符。</li>
<li><code>buf</code>：指向要发送数据的缓冲区的指针。</li>
<li><code>len</code>：要发送的数据的字节数。</li>
<li><code>flags</code>：设置发送操作的各种标志（通常为0）。</li>
<li><code>dest_addr</code>：指向<code>sockaddr</code>结构的指针，该结构包含目标地址和端口信息。</li>
<li><code>addrlen</code>：地址结构的大小。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回实际发送的字节数；</li>
<li>失败时，返回 -1，并设置 <code>errno</code>。</li>
</ul>
<h5 id="recvfrom-2"><a href="#recvfrom-2" class="headerlink" title="recvfrom(2)"></a>recvfrom(2)</h5><p>函数背景：在使用 UDP 进行网络通信时，由于其无连接的性质，需要一种机制来从数据报套接字接收数据，并同时获取发送方的地址信息。这就是 recvfrom() 函数的作用。</p>
<p>函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvfrom</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="keyword">struct</span> sockaddr *src_addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>sockfd</code>：要从中接收数据的套接字的文件描述符。</li>
<li><code>buf</code>：指向用于存储接收数据的缓冲区的指针。</li>
<li><code>len</code>：缓冲区的大小，指定了可以接收的最大字节数。</li>
<li><code>flags</code>：设置接收操作的各种标志（通常为0）。</li>
<li><code>src_addr</code>：指向<code>sockaddr</code>结构的指针，该结构在调用返回时将包含发送方的地址和端口信息。</li>
<li><code>addrlen</code>：是一个输入&#x2F;输出参数。在调用前，它应该包含<code>src_addr</code>所指向的地址结构的大小，调用返回时，它将包含实际填充的地址的大小。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回接收的字节数；</li>
<li>失败时，返回 -1，并设置 <code>errno</code>。</li>
</ul>
<p>注意事项：</p>
<ol>
<li>阻塞行为：默认情况下，recvfrom() 是阻塞的，这意味着如果没有数据可读，它会阻塞直到数据到达。可以通过设置套接字为非阻塞或使用 select&#x2F;poll 机制来改变这种行为。</li>
<li>地址信息：recvfrom() 除了返回数据之外，还返回发送方的地址信息，这对于 UDP 是非常有用的，因为这样就可以知道是谁发送的数据，并可以向正确的地址回复。</li>
</ol>
<p>举个栗子：</p>
<p>客户端发送数据给服务器端，服务器端显示数据，并向客户端发送一条信息表示自己已收到客户端发送来的数据，客户端显示该数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// proto.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PROTO_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROTO_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NAMESIZE	11</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE		1024</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IPSTRSIZE	40</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg_st</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">uint8_t</span> name[NAMESIZE];</span><br><span class="line">	<span class="type">uint32_t</span> math;</span><br><span class="line">	<span class="type">uint32_t</span> chinese;</span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rcver.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;proto.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sd;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">	<span class="type">socklen_t</span> addr_len;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_st</span> <span class="title">msg</span>;</span></span><br><span class="line">	<span class="type">char</span> buf[BUFSIZE] = <span class="string">&quot;Client data sends to Server successfully!&quot;</span>;</span><br><span class="line">	<span class="type">char</span> ipstr[IPSTRSIZE];</span><br><span class="line"></span><br><span class="line">	sd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;socket()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">	server_addr.sin_family = AF_INET;</span><br><span class="line">	server_addr.sin_port = htons(<span class="number">1989</span>);</span><br><span class="line">	server_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bind(sd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;bind()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr_len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (recvfrom(sd, &amp;msg, <span class="keyword">sizeof</span>(msg), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;addr_len) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">&quot;recvfrom()&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		inet_ntop(AF_INET, &amp;client_addr.sin_addr, ipstr, IPSTRSIZE);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---[Server] MESSAGE FROM %s:%d---\n&quot;</span>, ipstr, ntohs(client_addr.sin_port));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;NAME    = %s\n&quot;</span>, msg.name); <span class="comment">// 单字节数据传输不涉及大端/小端的转换</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;MATH    = %d\n&quot;</span>, msg.math);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;CHINESE = %d\n&quot;</span>, msg.chinese);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (sendto(sd, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, addr_len) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">&quot;sendto()&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	close(sd);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行rcver.c程序，然后在另一个终端中执行 <code>netstat -anu</code> 可发现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -anu</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State      </span><br><span class="line">udp        0      0 127.0.0.53:53           0.0.0.0:*                          </span><br><span class="line">udp        0      0 192.168.34.129:68       192.168.34.254:67       ESTABLISHED</span><br><span class="line">udp        0      0 0.0.0.0:631             0.0.0.0:*                          </span><br><span class="line">udp        0      0 0.0.0.0:54278           0.0.0.0:*                          </span><br><span class="line">udp        0      0 0.0.0.0:5353            0.0.0.0:*                          </span><br><span class="line">udp        0      0 0.0.0.0:1989            0.0.0.0:*                          </span><br><span class="line">udp6       0      0 :::48223                :::*                               </span><br><span class="line">udp6       0      0 :::5353                 :::*                               </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// snder.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;proto.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sd;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>, <span class="title">client_addr</span>;</span></span><br><span class="line">	<span class="type">socklen_t</span> addr_len;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">msg_st</span> <span class="title">msg</span> =</span> &#123;<span class="string">&quot;Alan&quot;</span>, <span class="number">90</span>, <span class="number">95</span>&#125;;</span><br><span class="line">	<span class="type">char</span> buf[BUFSIZE];</span><br><span class="line">	<span class="type">char</span> ipstr[IPSTRSIZE];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;IP&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	sd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;socket()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">	server_addr.sin_family = AF_INET;</span><br><span class="line">	server_addr.sin_port = htons(<span class="number">1989</span>);</span><br><span class="line">	<span class="keyword">if</span> (inet_pton(AF_INET, argv[<span class="number">1</span>], &amp;server_addr.sin_addr) &lt;= <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;inet_pton()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sendto(sd, &amp;msg, <span class="keyword">sizeof</span>(msg), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;sendto()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr_len = <span class="keyword">sizeof</span>(server_addr);</span><br><span class="line">	<span class="keyword">if</span> (recvfrom(sd, buf, BUFSIZE<span class="number">-1</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;addr_len) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;recvfrom()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line">	inet_ntop(AF_INET, &amp;client_addr.sin_addr, ipstr, IPSTRSIZE);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;---[Client] MESSAGE FROM %s:%d---\n&quot;</span>, ipstr, ntohs(client_addr.sin_port));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">	close(sd);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://flyingfox092-1300215590.cos.ap-shanghai.myqcloud.com/system-programming/sp7-udp-example-result.png"></p>
<p>以上程序可以在同一台主机上运行，也可以在不同主机上运行，先运行rcver程序，然后再另一个终端中执行snder程序。</p>
<h4 id="多播"><a href="#多播" class="headerlink" title="多播"></a>多播</h4><p>使用同一个 IP 多播地址接收多播数据包的所有主机构成了一个主机组，也称为多播组。一个多播组的成员是随时变动的，一台主机可以随时加入或离开多播组，多播组成员的数目和所在的地理位置也不受限制，一台主机也可以属于几个多播组。这个我们可以这样理解，多播地址就类似于 QQ 群号，多播组相当于 QQ 群，一个个的主机就相当于群里面的成员。</p>
<p>多播应用：</p>
<ul>
<li>单点对多点应用：点对多点应用是指一个发送者，多个接收者的应用形式，这是最常见的多播应用形式。典型的应用包括：媒体广播、媒体推送、信息缓存、事件通知和状态监视等。</li>
<li>多点对单点应用：多点对点应用是指多个发送者，一个接收者的应用形式。通常是双向请求响应应用，任何一端（多点或点）都有可能发起请求。典型应用包括：资源查找、数据收集、网络竞拍、信息询问等。</li>
<li>多点对多点应用：多点对多点应用是指多个发送者和多个接收者的应用形式。通常，每个接收者可以接收多个发送者发送的数据，同时，每个发送者可以把数据发送给多个接收者。典型应用包括：多点会议、资源同步、并行处理、协同处理、远程学习、讨论组、分布式交互模拟（DIS）、多人游戏等。</li>
</ul>
<p>多播编程：</p>
<p>多播程序框架主要包含套接字初始化、设置多播超时时间、加入多播组、发送数据、接收数据以及从多播组中离开几个方面。其步骤如下：</p>
<p>1）建立一个socket。</p>
<p>2）然后设置接收方多播的参数，例如超时时间TTL、本地回环许可LOOP等。</p>
<p>3）设置接收方加入多播组。</p>
<p>4）发送和接收数据。</p>
<p>5）从多播组离开。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span>          </span></span><br><span class="line"><span class="class">&#123;</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">imn_multiaddr</span>;</span> <span class="comment">// 多播组 IP，类似于 群号</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">imr_interface</span>;</span> <span class="comment">// 将要添加到多播组的 IP，类似于 成员号</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 当imr_interface 为 INADDR_ANY 时，选择的是默认组播接口。</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">in_addr_t</span> s_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  <em><strong>NAME</strong></em></p>
<p>  ​       <em>getsockopt, setsockopt - get and set options on sockets</em></p>
<p>  <em><strong>SYNOPSIS</strong></em></p>
<p>  ​       <em>#include &lt;sys&#x2F;types.h&gt;</em></p>
<p>  ​       <em>#include &lt;sys&#x2F;socket.h&gt;</em></p>
<p>  ​       <em>int getsockopt(int sockfd, int level, int optname, void *optval, socklen_t *optlen);</em></p>
<p>  ​       <em>int setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen);</em></p>
<p>  <em><strong>DESCRIPTION</strong></em></p>
<p>  ​       <em>getsockopt() and setsockopt() manipulate options for the socket referred to by the file descriptor sockfd.  Options may exist at multiple protocol levels; they are always present at the uppermost socket level.</em></p>
<p>  ​       <em>When  manipulating socket options, the level at which the option resides and the name of the option must be specified.  To manipulate options at the sockets API level, level is specified as SOL_SOCKET.  To manipulate options at any other level the protocol number of the appropriate protocol controlling the option is supplied.  For example, to indicate that an option is to be interpreted by the TCP protocol, level should be set to the protocol number of TCP;  see  getprotoent(3).</em></p>
<p>  ​       <em>The  arguments  optval  and optlen are used to access option values for setsockopt().  For getsockopt() they identify a buffer in which the value for the requested option(s) are to be returned.  For getsockopt(), optlen is a value-result argument, initially containing the size of the buffer pointed to by optval, and modified on return to indicate the actual size of the value returned.  If no option value is to be supplied or returned, optval may be NULL.</em></p>
<p>  ​       <em>Optname and any specified options are passed uninterpreted to the appropriate protocol module for interpretation.  The include file &lt;sys&#x2F;socket.h&gt; contains definitions for socket level options, described below.  Options at other protocol levels vary in format and name; consult the appropriate entries in section 4 of the manual.</em></p>
<p>  ​       <em>Most socket-level options utilize an int argument for optval.  For setsockopt(), the argument should be nonzero to enable a boolean option, or zero if the option is to be disabled.</em></p>
<p>  ​       <em>For a description of the available socket options see socket(7) and the appropriate protocol man pages.</em></p>
<p>  <em><strong>RETURN VALUE</strong></em></p>
<p>  ​       <em>On success, zero is returned for the standard options.  On error, -1 is returned, and errno is set appropriately.</em></p>
<p>  ​       <em>Netfilter allows the programmer to define custom socket options with associated handlers; for such options, the return value on success is the value returned by the handler.</em></p>
<p>  <em><strong>ERRORS</strong></em></p>
<p>  <em><strong>EBADF</strong></em>     <em>The argument sockfd is not a valid file descriptor.</em></p>
<p>  <em><strong>EFAULT</strong></em>    <em>The address pointed to by optval is not in a valid part of the process address space.  For getsockopt(), this error may also be returned if optlen is not in a valid part of the process address space.</em></p>
<p>  <em><strong>EINVAL</strong></em>    <em>optlen invalid in setsockopt().  In some cases this error can also occur for an invalid value in optval (e.g., for the IP_ADD_MEMBERSHIP option described in ip(7)).</em></p>
<p>  <em><strong>ENOPROTOOPT</strong></em>     <em>The option is unknown at the level indicated.</em></p>
<p>  <em><strong>ENOTSOCK</strong></em>     *The file descriptor sockfd does not refer to a socket.*setsockopt()</p>
</blockquote>
<h5 id="setsockopt"><a href="#setsockopt" class="headerlink" title="setsockopt()"></a>setsockopt()</h5><p>setsockopt() 函数可用于设置或更改套接字的选项。函数原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">setsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">const</span> <span class="type">void</span> *optval, <span class="type">socklen_t</span> optlen)</span>;</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>sockfd</code>：要设置选项的套接字的文件描述符。</li>
<li><code>level</code>：定义了哪一级别的选项应该被修改。常见的值为 <code>SOL_SOCKET</code>（常规套接字选项）, <code>IPPROTO_IP</code> (IP选项), <code>IPPROTO_TCP</code> (TCP选项) 等。</li>
<li><code>optname</code>：指定要设置的选项。例如，<code>SO_REUSEADDR</code>, <code>SO_RCVBUF</code>, <code>SO_LINGER</code> 等。</li>
<li><code>optval</code>：指向包含新选项值的缓冲区的指针。</li>
<li><code>optlen</code>：<code>optval</code> 缓冲区的大小。</li>
</ul>
<p>函数返回值：</p>
<ul>
<li>成功时，返回 0；</li>
<li>失败时，返回 -1，并设置 <code>errno</code>。</li>
</ul>
<blockquote>
<p>  level ：</p>
<ul>
<li>IPPROTO_IP</li>
</ul>
<p>  optname：</p>
<ul>
<li>IP_MULTICAST_LOOP 设置或禁止多播数据回送，即多播的数据是否回送到本地回环接口</li>
<li>IP_ADD_MEMBERSHIP 加入多播组</li>
<li>IP_DROP_MEMBERSHIP 离开多播组</li>
</ul>
<p>  默认情况下，当本机发送组播数据到某个网络接口时，在IP层，数据会回送到本地的回环接口，选项IP_MULTICAST_LOOP 用于控制数据是否回送到本地的回环接口。</p>
<p>  使用 IP_ADD_MEMBERSHIP 选项每次只能加入一个网络接口的IP地址到多播组，但并不是一个多播组仅允许一个主机IP地址加入，可以多次调用 IP_ADD_MEMBERSHIP 选项来实现多个IP地址加入同一个广播组，或者同一个IP地址加入多个广播组。</p>
<p>  optval：</p>
<ul>
<li>IP_MULTICAST_LOOP 选项对应传入 unsigned int 来确认是否支持多播数据回送</li>
<li>IP_ADD_MEMBERSHIP 传入 ip_mreq</li>
<li>IP_DROP_MEMBERSHIP 传入 ip_mreq</li>
</ul>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> loop = <span class="number">0</span>; <span class="comment">// 0 means disable, 1 means enable</span></span><br><span class="line"><span class="keyword">if</span> (setsockopt(socket, IPPROTO_IP, IP_MULTICAST_LOOP, &amp;loop, <span class="keyword">sizeof</span>(loop)) &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    perror(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mgroup_server.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_FOUND 		<span class="string">&quot;IP_FOUND&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_FOUND_ACK 	<span class="string">&quot;IP_FOUND_ACK&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MCAST 			<span class="string">&quot;224.0.0.88&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 说明:设置主机的TTL值，是否允许本地回环，加入多播组，然后服务器向加入多播组的主机发送数据，主机接收数据，并响应服务器。</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sockfd, client_fd;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">localaddr</span>, <span class="title">recvaddr</span>;</span></span><br><span class="line">	<span class="type">socklen_t</span> socklen;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ip_mreq</span> <span class="title">mreq</span>;</span></span><br><span class="line">	<span class="type">char</span> recv_buf[<span class="number">20</span>], send_buf[<span class="number">20</span>];</span><br><span class="line">	<span class="type">int</span> ttl = <span class="number">10</span>; <span class="comment">// 如果转发的次数等于10,则不再转发</span></span><br><span class="line">	<span class="type">int</span> loop = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot; socket()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;localaddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(localaddr));</span><br><span class="line">	localaddr.sin_family = AF_INET;</span><br><span class="line">	localaddr.sin_port = htons(<span class="number">6666</span>);</span><br><span class="line">	localaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">	<span class="keyword">if</span> (bind(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;localaddr, <span class="keyword">sizeof</span>(localaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;bind()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置多播的TTL值</span></span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sockfd, IPPROTO_IP, IP_MULTICAST_TTL, &amp;ttl, <span class="keyword">sizeof</span>(ttl)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;IP_MULTICAST_TTL&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置数据是否发送到本地回环接口</span></span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sockfd, IPPROTO_IP, IP_MULTICAST_LOOP, &amp;loop, <span class="keyword">sizeof</span>(loop)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;IP_MULTICAST_LOOP&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 加入多播组</span></span><br><span class="line">	mreq.imr_multiaddr.s_addr = inet_addr(MCAST);  <span class="comment">// 多播组的IP</span></span><br><span class="line">	mreq.imr_interface.s_addr = htonl(INADDR_ANY); <span class="comment">// 本机的默认接口IP,本机的随机IP</span></span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sockfd, IPPROTO_IP, IP_ADD_MEMBERSHIP, &amp;mreq, <span class="keyword">sizeof</span>(mreq)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;IP_ADD_MEMBERSHIP&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	socklen = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr);</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (recvfrom(sockfd, recv_buf, <span class="keyword">sizeof</span>(recv_buf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;recvaddr, &amp;socklen) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">&quot;recvfrom()&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; recv client addr : %s \n&quot;</span>, (<span class="type">char</span> *)inet_ntoa(recvaddr.sin_addr));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; recv client port : %d \n&quot;</span>, ntohs(recvaddr.sin_port));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; recv msg : %s \n&quot;</span>, recv_buf);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strstr</span>(recv_buf, IP_FOUND))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 响应客户端请求,将数据发送给客户端</span></span><br><span class="line">			<span class="built_in">strncpy</span>(send_buf, IP_FOUND_ACK, <span class="built_in">strlen</span>(IP_FOUND_ACK) + <span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span> (sendto(sockfd, send_buf, <span class="built_in">strlen</span>(IP_FOUND_ACK) + <span class="number">1</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;recvaddr, socklen) &lt; <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				perror(<span class="string">&quot;sendto()&quot;</span>);</span><br><span class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot; send ack msg to client !\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 离开多播组</span></span><br><span class="line">	<span class="keyword">if</span> (setsockopt(sockfd, IPPROTO_IP, IP_DROP_MEMBERSHIP, &amp;mreq, <span class="keyword">sizeof</span>(mreq)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;IP_DROP_MEMBERSHIP&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(sockfd);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">![mgroup](Images/mgroup.png)![mgroup](Images/mgroup.png)<span class="comment">// mgroup_client.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_FOUND 		<span class="string">&quot;IP_FOUND&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IP_FOUND_ACK 	<span class="string">&quot;IP_FOUND_ACK&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">广播与多播只支持UDP协议，因为TCP协议是端到端，这与广播与多播的理念相冲突</span></span><br><span class="line"><span class="comment">广播是局域网中一个主机对所有主机的数据通信，而多播是一个主机对一组特定的主机进行通信.多播可以是因特网，而广播只能是局域网。多播常用于视频电话，网上会议等。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">setsockopt设置套接字选项可以设置多播的一些相关信息</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">IP_MULTICAST_TTL	//设置多播的跳数值</span></span><br><span class="line"><span class="comment">IP_ADD_MEMBERSHIP	//将主机的指定接口加入多播组，以后就从这个指定的接口发送与接收数据</span></span><br><span class="line"><span class="comment">IP_DROP_MEMBERSHIP	//主机退出多播组</span></span><br><span class="line"><span class="comment">IP_MULTICAST_IF		//获取默认的接口或设置多播接口</span></span><br><span class="line"><span class="comment">IP_MULTICAST_LOOP	//设置或禁止多播数据回送，即多播的数据是否回送到本地回环接口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">例子:</span></span><br><span class="line"><span class="comment">int ttl=255;</span></span><br><span class="line"><span class="comment">setsockopt(socket,IPPROTO_IP,IP_MULTICAST_TTL,&amp;ttl,sizeof(ttl));	//设置跳数</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">socket           -套接字描述符</span></span><br><span class="line"><span class="comment">PROTO_IP         -选项所在的协议层</span></span><br><span class="line"><span class="comment">IP_MULTICAST_TTL -选项名</span></span><br><span class="line"><span class="comment">&amp;ttl             -设置的内存缓冲区</span></span><br><span class="line"><span class="comment">sizeof(ttl)      -设置的内存缓冲区长度</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">struct in_addr in;</span></span><br><span class="line"><span class="comment">setsockopt(socket,IPPROTO_IP,IP_MUTLICAST_IF,&amp;in,sizeof(in));		//设置组播接口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">int loop=1;</span></span><br><span class="line"><span class="comment">setsockopt(socket,IPPROTO_IP,IP_MULTICAST_LOOP,&amp;loop,sizeof(loop));	//设置数据回送到本地回环接口</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">struct ip_mreq req;</span></span><br><span class="line"><span class="comment">setsockopt(socket,IPPROTO_IP,IP_ADD_MEMBERSHIP,&amp;req,sizeof(req));	//加入组播组</span></span><br><span class="line"><span class="comment">setsockopt(socket,IPPROTO_IP,IP_DROP_MEMBERSHIP,&amp;req,sizeof(req));	//离开组播组</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MCAST_ADDR <span class="string">&quot;224.0.0.88&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> sockfd;</span><br><span class="line">	<span class="type">char</span> send_buf[<span class="number">20</span>];</span><br><span class="line">	<span class="type">char</span> recv_buf[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span> <span class="comment">// 多播地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">our_addr</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">recvaddr</span>;</span></span><br><span class="line">	<span class="type">int</span> so_broadcast = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">socklen_t</span> socklen;</span><br><span class="line"></span><br><span class="line">	sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;server_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line">	server_addr.sin_family = AF_INET;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// server_addr.sin_addr.s_addr = inet_addr(&quot;127.0.0.1&quot;);</span></span><br><span class="line">	server_addr.sin_addr.s_addr = inet_addr(MCAST_ADDR); <span class="comment">// 多播地址</span></span><br><span class="line">	server_addr.sin_port = htons(<span class="number">6666</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 客户端绑定通信端口，否则系统自动分配</span></span><br><span class="line">	<span class="built_in">memset</span>(&amp;our_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(our_addr));</span><br><span class="line">	our_addr.sin_family = AF_INET;</span><br><span class="line">	our_addr.sin_port = htons(<span class="number">7777</span>);</span><br><span class="line">	our_addr.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">// MCAST_ADDR</span></span><br><span class="line">	<span class="comment">// 自定义地址如果为有效地址</span></span><br><span class="line">	<span class="comment">// 则协议栈将自定义地址与端口信息发送到接收方</span></span><br><span class="line">	<span class="comment">// 否则协议栈将使用默认的回环地址与自动端口</span></span><br><span class="line">	<span class="comment">// our_addr.sin_addr.s_addr = inet_addr(&quot;127.0.0.10&quot;);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bind(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;our_addr, <span class="keyword">sizeof</span>(our_addr)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(<span class="string">&quot;bind()&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	socklen = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr);</span><br><span class="line">	<span class="built_in">strncpy</span>(send_buf, IP_FOUND, <span class="built_in">strlen</span>(IP_FOUND) + <span class="number">1</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> count = <span class="number">0</span>; count &lt; <span class="number">1</span>; count++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (sendto(sockfd, send_buf, <span class="built_in">strlen</span>(send_buf) + <span class="number">1</span>, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, socklen) != <span class="built_in">strlen</span>(send_buf) + <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">&quot;sendto()&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (recvfrom(sockfd, recv_buf, <span class="keyword">sizeof</span>(recv_buf), <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;recvaddr, &amp;socklen) &lt; <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			perror(<span class="string">&quot;recvfrom()&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; recv server addr : %s \n&quot;</span>, (<span class="type">char</span> *)inet_ntoa(recvaddr.sin_addr));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; recv server port : %d \n&quot;</span>, ntohs(recvaddr.sin_port));</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; recv server msg : %s \n&quot;</span>, recv_buf);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(sockfd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="https://flyingfox092-1300215590.cos.ap-shanghai.myqcloud.com/system-programming/sp7-mgroup.png"></p>
<h3 id="流式套接字"><a href="#流式套接字" class="headerlink" title="流式套接字"></a>流式套接字</h3><p>待更新。。。</p>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "http://example.com/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "http://example.com/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/";
            const title         = "「第七章：网络编程」";
            const excerpt       = `介绍网络编程中的套接字相关内容：报式套接字、流式套接字（待更新）`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/system-programming/" rel="tag">system programming</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-09-01T08:59:59.317Z" itemprop="dateModified">最后编辑：2023-09-01</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 第六章：进程间通信" href="/2023/08/25/Chapter6_进程间通信/">&lt; 上一篇</a>
            </div>
            
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.png" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                17
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                5
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                7
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E7%9A%84%E4%BC%A0%E8%BE%93%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">跨主机的传输要注意的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E5%BA%8F%E9%97%AE%E9%A2%98"><span class="toc-text">字节序问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E8%8A%82%E5%BA%8F%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="toc-text">字节序转换函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2%E5%87%BD%E6%95%B0"><span class="toc-text">格式转换函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#inet-pton-3"><span class="toc-text">inet_pton(3)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#inet-ntop-3"><span class="toc-text">inet_ntop(3)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E9%BD%90"><span class="toc-text">对齐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E9%95%BF%E5%BA%A6%E9%97%AE%E9%A2%98"><span class="toc-text">类型长度问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-text">套接字</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#socket-2"><span class="toc-text">socket(2)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E5%BC%8F%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-text">报式套接字</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-text">常用函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#bind-2"><span class="toc-text">bind(2)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sendto-2"><span class="toc-text">sendto(2)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#recvfrom-2"><span class="toc-text">recvfrom(2)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E6%92%AD"><span class="toc-text">多播</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#setsockopt"><span class="toc-text">setsockopt()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E5%A5%97%E6%8E%A5%E5%AD%97"><span class="toc-text">流式套接字</span></a></li></ol></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E3%80%8A%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B%E5%AE%9E%E8%B7%B5%EF%BC%88C%E8%AF%AD%E8%A8%80%E7%89%88%EF%BC%89%E3%80%8B/">《系统编程实践（C语言版）》</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/">二进制</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AF%E4%BB%B6%E6%BF%80%E6%B4%BB/">软件激活</a><span class="category-list-count">1</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/BurpSuite/" style="font-size: 0.6em;">BurpSuite</a> <a href="/tags/DynELF/" style="font-size: 0.6em;">DynELF</a> <a href="/tags/ELF/" style="font-size: 0.6em;">ELF</a> <a href="/tags/SSH%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95/" style="font-size: 0.6em;">SSH免密登录</a> <a href="/tags/system-programming/" style="font-size: 0.8em;">system programming</a> <a href="/tags/%E5%85%B1%E4%BA%AB%E5%BA%93/" style="font-size: 0.6em;">共享库</a> <a href="/tags/%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5/" style="font-size: 0.6em;">动态链接</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2023/09/01/Chapter7_%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/"><i class="fa  fa-book"></i> 第七章：网络编程</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/08/25/Chapter6_%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1/"><i class="fa  fa-book"></i> 第六章：进程间通信</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/08/22/Chapter3_%E8%BF%9B%E7%A8%8B/"><i class="fa  fa-book"></i> 第三章：进程</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/08/18/%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0/"><i class="fa  fa-book"></i> 钩子函数|进程的终止方式</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/08/17/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E7%9A%84%E5%88%86%E6%9E%90/"><i class="fa  fa-book"></i> 解析命令行参数</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 江城子同学 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by flyingfox.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                    <div class="box theme-box" id="snow-switch">
                        <span class="fa fa-snowflake-o"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>

    <div>
        <canvas id="snow"></canvas>
        <script async src="/js/snow.min.js"></script>
    </div>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>